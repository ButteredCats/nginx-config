upstream redlib {
	zone redlib 32k;
	# When Redlib needs to restart it takes about 20 seconds with IPv6 rotation
	# When that happens we'll failover to the backup server, which is Redlib over Tor, but which is also far slower
	# Because we also need to pass on 404's we'll get some false hits to the Tor server
	server 127.0.0.1:8081 max_fails=4 fail_timeout=30s;
	server 127.0.0.2:8081 max_fails=0 backup;
	keepalive 4;
}

# https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path
proxy_cache_path /var/cache/nginx/redlib levels=1:2 keys_zone=redlib_cache:10m max_size=20g inactive=7d use_temp_path=off;

### STAGING START ###
# CLEARNET START
server {
	listen		443 ssl;
	listen		[::]:443 ssl;
	listen		443 quic;
	listen		[::]:443 quic;
	server_name	staging-redlib.catsarch.com;

	# Service name variable
	set $service_name redlib;

	# Debug headers for staging sites
	include conf.d/staging/headers/site-debug-headers.conf;

	# SSL config
	include conf.d/staging/ssl.conf;

	# Darknet location headers
	more_set_headers -t 'text/html' "Onion-Location: http://staging-redlib.catsarchywsyuss6jdxlypsw5dc7owd5u5tr6bujxb7o6xw2hipqehyd.onion$request_uri";
	more_set_headers -t 'text/html' "X-I2P-Location: http://yfpe4v2meqe5vusmbf7n7a4ncnstzmpiy4czolcisz4h3t7kgxna.b32.i2p$request_uri";

	# Dealing with large cookies for Redlib
	include conf.d/production/sites/redlib/cookies.conf;

	# Anubis config
	include conf.d/staging/anubis.conf;
}
server {
	listen unix:/run/nginx.sock;
	server_name staging-redlib.catsarch.com;

	# Debug headers for staging sites
	include conf.d/staging/headers/site-debug-headers.conf;

	# Only the stats from Anubis in front of this need to be logged
	vhost_traffic_status_bypass_stats on;

	# Cookie flags
	proxy_cookie_flags ~ secure samesite=lax;

	# Base Redlib config
	include conf.d/staging/sites/redlib/base.conf;
}
# CLEARNET END
# DARKNET START
server {
	# Tor
	listen		unix:/run/nginx.sock;
	# I2P
	listen		127.0.0.1:6667;
	server_name	staging-redlib.catsarchywsyuss6jdxlypsw5dc7owd5u5tr6bujxb7o6xw2hipqehyd.onion staging-redlib.catsarch.i2p;

	# Service name variable
	set $service_name redlib;

	# Debug headers for staging sites
	include conf.d/staging/headers/site-debug-headers.conf;

	# Cookie flags
	proxy_cookie_flags ~ samesite=lax;

	# Base Redlib config
	include conf.d/staging/sites/redlib/base.conf;

}
# DARKNET END
# REDIRECT START
server {
	listen		80;
	listen		[::]:80;
	server_name	staging-redlib.catsarch.com;

	# Redirect config
	include conf.d/staging/redirects/redirect.conf;
}
# REDIRECT END
### STAGING END ###

### PRODUCTION START ###
# CLEARNET START
server {
	listen		443 ssl;
	listen		[::]:443 ssl;
	listen		443 quic;
	listen		[::]:443 quic;
	server_name	redlib.catsarch.com;

	# Service name variable
	set $service_name redlib;

	# SSL config
	include conf.d/production/ssl.conf;

	# Darknet location headers
	more_set_headers -t 'text/html' "Onion-Location: http://redlib.catsarchywsyuss6jdxlypsw5dc7owd5u5tr6bujxb7o6xw2hipqehyd.onion$request_uri";
	more_set_headers -t 'text/html' "X-I2P-Location: http://yfpe4v2meqe5vusmbf7n7a4ncnstzmpiy4czolcisz4h3t7kgxna.b32.i2p$request_uri";

	# Dealing with large cookies for Redlib
	include conf.d/production/sites/redlib/cookies.conf;

	# Anubis config
	include conf.d/production/anubis.conf;
}
server {
	listen unix:/run/nginx.sock;
	server_name redlib.catsarch.com;

	# Only the stats from Anubis in front of this need to be logged
	vhost_traffic_status_bypass_stats on;

	# Cookie flags
	proxy_cookie_flags ~ secure samesite=lax;

	# Base Redlib config
	include conf.d/production/sites/redlib/base.conf;
}
# CLEARNET END
# DARKNET START
server {
	# Tor
	listen		unix:/run/nginx.sock;
	# I2P
	listen		127.0.0.1:6667;
	server_name	redlib.catsarchywsyuss6jdxlypsw5dc7owd5u5tr6bujxb7o6xw2hipqehyd.onion yfpe4v2meqe5vusmbf7n7a4ncnstzmpiy4czolcisz4h3t7kgxna.b32.i2p redlib.catsarch.i2p;

	# Service name variable
	set $service_name redlib;

	# Cookie flags
	proxy_cookie_flags ~ samesite=lax;

	# Base Redlib config
	include conf.d/production/sites/redlib/base.conf;
}
# DARKNET END
# REDIRECT START
server {
	listen		80;
	listen		[::]:80;
	server_name	redlib.catsarch.com;

	# Redirect config
	include conf.d/production/redirects/redirect.conf;
}
# REDIRECT END
### PRODUCTION END ###
