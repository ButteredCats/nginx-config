# Common HTTP headers typically used across our sites
# If any site needs to change one of these then more_set_headers can just overwrite the old value

# Disable MIME sniffing
# https://en.wikipedia.org/wiki/Content_sniffing
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/X-Content-Type-Options
more_set_headers 'X-Content-Type-Options: nosniff';

# Never send referrer to other sites
# HTML needs it for any form of link. CSS needs it because it can grab external styles inside of it
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Referrer-Policy
# JavaScript follows the value the HTML had. Couldn't find a solid source for this so I tested it myself with fetch. Might be able to be overridden inside the JS?
# Couldn't find a good source for redirects either, testing it myself in Firefox and Chrome didn't show one being sent when no Referrer-Policy was specified. Keeping it enabled just in case
more_set_headers -t 'text/html text/css' 'Referrer-Policy: no-referrer';
more_set_headers -s '301 302 303 307 308' 'Referrer-Policy: no-referrer';

# Disable DNS prefetching
# Only applies to HTML pages since nothing else has links to prefetch
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-DNS-Prefetch-Control
more_set_headers -t 'text/html' 'X-DNS-Prefetch-Control: off';

## Cross Origin options ##
# COEP and CORP are sometimes changed on sites, COOP never is

# Who's resources can we embed?
# require-corp
# 	- Any resource who's Cross-Origin-Resource-Policy header allows it. No cookies will be sent and any received will be ignored.
# 	- Any resource that has the "crossorigin" HTML attribute on our page, who's requested resource has a Access-Control-Allow-Origin header that allows our origin. If the crossorigin attribute is set to "use-credentials" and the remote resource has the Access-Control-Allow-Credentials header set to true (except if the Access-Control-Allow-Origin header is set to "*"), the browser will send and set cookies to/from the resource. Otherwise they wont be sent and any received will be ignored.
# credentialless
# 	- Any resource can be embedded but no cookies will be sent and any received will be ignored.
# unsafe-none
# 	- Any resource can be embedded and the browser will send and set cookies to/from the resource. This is the same as not sending the header.
# Notes:
# 	- The cookie's samesite attribute changes whether the cookie will actually be sent or not.
# 	- Cookies sent are from the cross origin site, not ours. Any recieved from the cross origin site will be set for that site only.
# Sources:
# 	- https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Cross-Origin-Embedder-Policy
# 	- https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Attributes/crossorigin
# 	- My own testing on when the remote resource's Set-Cookie header is accepted
more_set_headers -t 'text/html' 'Cross-Origin-Embedder-Policy: require-corp'; 

# Never share browsing contexts with other sites
# https://scotthelme.co.uk/coop-and-coep/#coop-cross-origin-opener-policy
more_set_headers -t 'text/html' 'Cross-Origin-Opener-Policy: same-origin';

# Where can our resources be embedded?
# same-origin, same subdomain and domain
# same-site, same domain
# cross-origin, anywhere
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Cross-Origin-Resource-Policy
more_set_headers 'Cross-Origin-Resource-Policy: same-origin';
##########################

# Notes on some other options that were purposely not included:

## Permissions-Policy
# This header is only supported by Chromium based browsers
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Permissions-Policy#browser_compatibility
# It's also giant, and doesn't support any form of "deny all" directive
# https://www.permissionspolicy.com/
# https://github.com/w3c/webappsec-permissions-policy/issues/189
# When it has wider support and gets some form of "deny all" it'll be added here

## X-Frame-Options
# This has been obsoleted by the frame-ancestors directive within the Content-Security-Policy header
# In cases where frame-ancestors is supported the browser will ignore this header
# https://www.w3.org/TR/CSP2/#frame-ancestors-and-frame-options
# Content-Security-Policy headers are set for all of our sites and include frame-ancestors
# and Content-Security-Policy is supported by all major browsers
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Content-Security-Policy/frame-ancestors#browser_compatibility

## X-XSS-Protection
# This option doesn't exist in modern browsers
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/X-XSS-Protection#browser_compatibility
# It also can create vulnerabilities in older browsers that support it when used with the incorrect options
# However, "1; mode=block" should be safe
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-XSS-Protection#vulnerabilities_caused_by_xss_filtering
