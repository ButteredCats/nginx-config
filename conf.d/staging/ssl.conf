# Certificates
# Let's Encrypt cert with the tlsserver profile
# When it's public we'll swap to the shortlived profile
# https://letsencrypt.org/docs/profiles/
ssl_certificate		/etc/ssl/private/certificates/catsarch.com.crt;
ssl_certificate_key	/etc/ssl/private/certificates/catsarch.com.key;

# Only enable TLSv1.3
# More notes on this at the bottom
# https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_protocols
ssl_protocols TLSv1.3;

# Allow tickets to be resumed for one day
# Tickets are on by default
# https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_session_timeout
ssl_session_timeout 1d;

# Force clients to connect with HTTPS
# Set with more_set_headers so it isn't deleted on error pages
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Strict-Transport-Security
more_set_headers 'Strict-Transport-Security: max-age=63072000; includeSubdomains; preload';

# Inform clients that HTTP/3.0 is available
# Set with more_set_headers so it isn't deleted on error pages
# $server_port is used so that the correct port is always returned no matter what
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Alt-Svc
more_set_headers 'alt-svc: h3=":$server_port"; ma=2592000';

# Verify that a client actually wanted to talk to us before sending anything to them with HTTP3
# This prevents us being used for an amplification attack
# https://nginx.org/en/docs/http/ngx_http_v3_module.html#quic_retry
# https://datatracker.ietf.org/doc/html/rfc9000#name-address-validation
quic_retry on;

# Send many quic packets in one buffer to the kernel instead of many in multiple buffers
# https://nginx.org/en/docs/http/ngx_http_v3_module.html#quic_gso
# https://blog.cloudflare.com/accelerating-udp-packet-transmission-for-quic/
quic_gso on;


### For the future:
## Certificate compression
# Right now this just results in an error
# https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_certificate_compression
# https://github.com/nginx/nginx/issues/956#issuecomment-3462940188


### Notes on some other options that were purposely not included:
## ssl_early_data https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_early_data
# At the time of writing this nothing hosted here is vulnerable to replay attacks in a way that matters
# However I'd rather not risk creating a vulnerability for a small optmization should
# we host something that would be at risk of it in the future.

## ssl_ecdh_curve https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_ecdh_curve
# I see no reason to limit the curves, clients will choose what they think is best
# In the past specifying this caused the X25519MLKEM768 post quantum curve to not be enabled when it was added to OpenSSL
# If I hadn't been interested in post quantum encryption at the time I probably never would have known,
# so in the interest of reducing human error I'm not specifying it and leaving it on the default of "auto"

## ssl_session_cache https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_session_cache
# ssl_session_cache is only useful for TLSv1.2 and older, TLSv1.3 has tickets that are enabled
# in NGINX by default and stored by the client. This way we don't have to have a limit on
# how many sessions we can cache. It's also not possible to have TLSv1.3 use tickets while
# ssl_session_cache is enabled, so I opted to disable it and TLSv1.2 instead.

## ssl_stapling https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_stapling
# Let's Encrypt no longer has an OCSP responder, no need!
# https://letsencrypt.org/2025/08/06/ocsp-service-has-reached-end-of-life


### Notes on only using TLSv1.3:
## Everything major supports TLSv1.3 nowadays
# https://caniuse.com/tls1-3

## Not having TLSv1.2 enabled allows us to have stateless resumption,
# meaning we don't have to worry about caching tickets ourselves.
# This prevents running out of room in the cache, which is especially important
# because logs aren't enabled to see if it's happening
# https://github.com/mozilla/server-side-tls/issues/282
