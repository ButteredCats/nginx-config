# Error pages
include conf.d/staging/error-pages/error-pages.conf;

# Special files
include conf.d/staging/special-files.conf;

# Common headers
include conf.d/staging/headers/common-headers.conf;

# Set of directives that tell the browser what can be loaded from where
# Possible options can be found here https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy
# Browsers will show things that were blocked and what directive blocked them in the console
# base-uri, frame-ancestors, and form-action don't fall back to default-src
more_set_headers -t 'text/html' "Content-Security-Policy: default-src 'none'; style-src 'self'; font-src 'self'; img-src 'self'; manifest-src 'self'; base-uri 'none'; frame-src https://www.youtube-nocookie.com/embed/; frame-ancestors 'none'; form-action 'self'";

# Site specific proxy cache options
# https://nginx.org/en/docs/http/ngx_http_proxy_module.html
proxy_cache_min_uses 3;
proxy_cache_key "$request_uri";

# Turn Intellectual's two Vary headers into one
more_set_headers -t 'text/html' 'Vary: Accept-Encoding, Cookie';

# Pages
location / {
	# All locations options
	include conf.d/staging/sites/intellectual/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD { deny all; }
	
	# Try to minimize requests to these pages
	proxy_cache_valid 200 7d; # The only thing that might update on these pages are the annotations, which I imagine don't change much
	proxy_cache_lock on;

	# Intellectual stores it's one and only setting (which is theme) in a cookie named "settings"
	# It changes the link to the CSS file in the page itself
	proxy_cache_key "$request_uri $cookie_settings";
}
location /search {
	# All locations options
	include conf.d/staging/sites/intellectual/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD { deny all; }

	# Try to minimize requests to these pages
	proxy_cache_valid 200 1d; # Tradeoff between having the newest songs listed while minimizing requests
	proxy_cache_lock on;

	# Intellectual stores it's one and only setting (which is theme) in a cookie named "settings"
	# It changes the link to the CSS file in the page itself
	proxy_cache_key "$request_uri $cookie_settings";
}
location /settings {
	# All locations options
	include conf.d/staging/sites/intellectual/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD POST { deny all; }

	# Allow caching POST requests so the settings page can function even if offline
	proxy_cache_methods GET HEAD POST;

	# Add Set-Cookie onto our usual list of ignored headers so that the responses here can be cached
	proxy_ignore_headers Cache-Control Expires X-Accel-Expires X-Accel-Buffering Set-Cookie;

	# Don't refresh the redirects for saving cookies, there's no need as these won't change
	# No extra time is given to 200 responses because the settings page could get extra themes with no way to automatically invalidate the proxy cache
	proxy_cache_valid 303 1y;

	# Intellectual stores it's one and only setting (which is theme) in a cookie named "settings"
	# It changes the link to the CSS file in the page itself
	# $request_body is because that's all that's used by Intellectual to return the correct cookie
	proxy_cache_key "$request_uri $request_method $request_body $cookie_settings";
}

# Resources
# Matches *.css, *.svg, and *.woff2
# These have strong version control and are internal
# https://github.com/Insprill/intellectual/tree/master/static
location ~ \.(?:css|svg|woff2)$ {
	# All locations options
	include conf.d/staging/sites/intellectual/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD { deny all; }

	# Never refresh, these won't change because of their version control
	proxy_cache_valid 200 1y;

	# These will always need to be used by multiple people and are essential to the site
	proxy_cache_min_uses 1;
}
# These will never change and are external
location /api/image {
	# All locations options
	include conf.d/staging/sites/intellectual/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD { deny all; }

	# Try to minimize requests to these resources
	proxy_cache_valid 200 206 1y; # Never refresh, these won't change
	proxy_cache_lock on;
}
# Intellectual has great clientside caching already, so this is just serverside caching
