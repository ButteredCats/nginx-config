# Error pages
include conf.d/staging/error-pages/error-pages.conf;

# Special files
include conf.d/staging/special-files.conf;

# Common headers
include conf.d/staging/headers/common-headers.conf;

# Set of directives that tell the browser what can be loaded from where
# Possible options can be found here https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy
# Browsers will show things that were blocked and what directive blocked them in the console
# base-uri, frame-ancestors, and form-action don't fall back to default-src
# Redlib has a competent CSP by default but sends it for every resource, so instead we hide the value from the proxy and only send it on the HTML page ourselves
more_set_headers -t 'text/html' "Content-Security-Policy: default-src 'none'; font-src 'self'; script-src 'self' blob:; manifest-src 'self'; media-src 'self' data: blob: about:; style-src 'self' 'unsafe-inline'; base-uri 'none'; img-src 'self' data:; form-action 'self'; frame-ancestors 'none'; connect-src 'self'; worker-src blob:";

# Relaxed for videos and common image formats to let embeds play in things like Discord
more_set_headers -t 'audio/MP2T video/MP2T image/png image/jpeg image/gif image/webp' 'Cross-Origin-Resource-Policy: cross-origin'; 
# We only want this on HTML pages, which we'll do ourselves
proxy_hide_header Content-Security-Policy;

# We don't need this for the reasons explained in the common header config file
proxy_hide_header X-Frame-Options;
# We control cache in other ways
proxy_hide_header Expires;
# Whole bunch of random headers from Reddit that can be included in images
proxy_hide_header nel;
proxy_hide_header report-to;
proxy_hide_header via;
proxy_hide_header reddit-io-info;
proxy_hide_header x-envoy-upstream-service-time;
proxy_hide_header x-imo-features;
proxy_hide_header x-reddit-backend;
proxy_hide_header x-reddit-pod-ip;
proxy_hide_header x-amz-version-id;
proxy_hide_header x-amz-server-side-encryption;
proxy_hide_header x-canonical-filename-image-generation;
proxy_hide_header reddit-stats;
proxy_hide_header x-auth-debug;
proxy_hide_header x-reddit-cq;

# Site specific proxy cache options
# https://nginx.org/en/docs/http/ngx_http_proxy_module.html
proxy_cache_min_uses 3;
proxy_cache_key "$request_uri";

# Redlib needs to go to the next upstream on 404's too because that's what it responds with for errors
proxy_next_upstream error timeout invalid_header non_idempotent http_404 http_429 http_500 http_502 http_503 http_504;

# Dealing with large cookies
include conf.d/production/sites/redlib/cookies.conf;

# Pages
location / {
	# All locations options
	include conf.d/staging/sites/redlib/all-locations.conf;

	# POST is required for subbing and such
	limit_except GET HEAD POST { deny all; }

	# Don't include proxy cache as it would have to vary on subscription and filter cookies, both of which are going to have massive variation
}

# Resources
# Typically version control is poor since it's based on the release version that hardly ever changes
# We edit this to have better version control by using the git commit
# Has strong version control and is internal
location = /style.css {
	# All locations options
	include conf.d/staging/sites/redlib/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD { deny all; }

	# Enable proxy caching for this location
	proxy_cache redlib_cache;

	# Never refresh, this won't change because of it's version control
	proxy_cache_valid 200 1y;

	# This will always need to be used by multiple people and are essential to the site
	proxy_cache_min_uses 1;

	# Caching options
	include conf.d/staging/cache-options/static-with-version-control.conf;
}
# Matches /touch-icon-iphone.png, /apple-touch-icon.png, /favicon.ico, /Inter.var.woff2, /playHLSVideo.js, /highlighted.js, /check_update.js, and /copy.js
# Usually these have no version control
# However, we'll use dynamic etags to give some version control
# These have etags and are internal
location ~ \/(?:(?:touch-icon-iphone|apple-touch-icon)\.png|favicon\.ico|Inter\.var\.woff2|(?:playHLSVideo|highlighted|check_update|copy)\.js)$ {
	# All locations options
	include conf.d/staging/sites/redlib/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD { deny all; }

	# Dynamic etags
	# https://github.com/dvershinin/ngx_dynamic_etag
	dynamic_etag on;
	dynamic_etag_types *;
	dynamic_etag_strength weak;

	# Enable proxy caching for this location
	proxy_cache redlib_cache;

	# These will always need to be used by multiple people and are essential to the site
	proxy_cache_min_uses 1;

	# Caching options
	include conf.d/staging/cache-options/static-with-etag-or-last-modified.conf;
}
# For some reason the dynamic etag on this is constantly changing
# so instead of that we'll do the bad compromise of a short cache time since it's a big resource
# Has no version control and is internal
location = /hls.min.js {
	# All locations options
	include conf.d/staging/sites/redlib/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD { deny all; }

	# Enable proxy caching for this location
	proxy_cache redlib_cache;

	# This will always need to be used by multiple people and are essential to the site
	proxy_cache_min_uses 1;

	# Have clients cache this for 1 week
	more_set_headers -s '200' 'Cache-Control: max-age=604800';
}

# Contains profile pictures
# Has a Last-Modified header and is external
location /avatars/ {
	# All locations options
	include conf.d/staging/sites/redlib/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD { deny all; }

	# Enable proxy caching for this location
	proxy_cache redlib_cache;

	# Try to minimize requests to these resources
	proxy_cache_lock on;

	# Caching options
	include conf.d/staging/cache-options/static-with-etag-or-last-modified.conf;
}
# Matches /emoji/ and /emotes/
# /emoji/ are emojis that are used in flairs
# I don't believe these can be edited once uploaded
# Doesn't seem they can ever change and are external
# /emotes/ *were* emotes, but it seems like Reddit removed these
# they all show up as a one dizzy face now. Seems like it'll never change
# Both of these shouldn't change and are external
location ~ \/(?:emoji|emotes)\/ {
	# All locations options
	include conf.d/staging/sites/redlib/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD { deny all; }

	# Enable proxy caching for this location
	proxy_cache redlib_cache;

	# Try to minimize requests to these resources
	proxy_cache_valid 200 206 1y; # Never refresh, these won't change
	proxy_cache_lock on;

	# Caching options
	include conf.d/staging/cache-options/images.conf;
}
# Matches /img/, /thumb/, /preview/, /vid/, and /hls/
# img, thumb, preview are images for posts
# vid and hls are videos
# These should never change and are external
location ~ \/(?:img|thumb|preview|vid|hls)\/ {
	# All locations options
	include conf.d/staging/sites/redlib/all-locations.conf;

	# Limit allowed HTTP methods
	limit_except GET HEAD { deny all; }

	# Enable proxy caching for this location
	proxy_cache redlib_cache;

	# Try to minimize requests to these resources
	proxy_cache_valid 200 206 1y; # Never refresh, these won't change
	proxy_cache_lock on;

	# Caching options
	include conf.d/staging/cache-options/images.conf;
}
