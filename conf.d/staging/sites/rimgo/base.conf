# Error pages
include conf.d/staging/error-pages/error-pages.conf;

# Special files
include conf.d/staging/special-files.conf;

# Common headers
include conf.d/staging/headers/common-headers.conf;

# Has a competent CSP by default, but sends it for everything. Send one for the HTML and we hide it for everything else below
more_set_headers -t 'text/html' "Content-Security-Policy: default-src 'none'; style-src 'self'; img-src 'self'; media-src 'self'; manifest-src 'self'; base-uri 'none'; frame-ancestors 'none'; form-action 'self'";

# Relaxed for common image and video formats so they can embed on other pages for use with replacer plugins or somewhere like Discord
more_set_headers -t 'image/png image/jpeg image/gif image/webp video/mp4' 'Cross-Origin-Resource-Policy: cross-origin'; 

# Explained above with CSP
proxy_hide_header Content-Security-Policy;
# We don't need X-Robots-Tag, our robots.txt outright denies crawlers
proxy_hide_header X-Robots-Tag;
# Why permissions policy shouldn't be sent is talked about in the common headers config
proxy_hide_header Permissions-Policy;
# Just an info header that doesn't need to be sent
proxy_hide_header X-Cache;
# We don't need this for the reasons explained in the common header config file
proxy_hide_header X-Frame-Options;

# Site specific proxy cache options
# https://nginx.org/en/docs/http/ngx_http_proxy_module.html
proxy_cache_min_uses 3;
proxy_cache_key "$request_uri";

# Pages
location = / {
	# All locations options
	include conf.d/staging/sites/rimgo/all-locations.conf;
	
	# Rimgo sends a Cache-Control header here for a year, but this has info the user might want to see updated (version, country, provider, and using cloudflare) so lets strip it
	# Clear it with more_clear_headers so it doesn't stop applying the proxy_hide_header options above
	more_clear_headers 'Cache-Control';
}
location / {
	# All locations options
	include conf.d/staging/sites/rimgo/all-locations.conf;
}
# Matches /gallery/ and /trending/
# gallery is the actual page for images/videos, and trending is the page with trending images/videos
location ~ \/(?:gallery|trending)\/ {
	# All locations options
	include conf.d/staging/sites/rimgo/all-locations.conf;

	# Try to minimize requests to these pages
	proxy_cache_valid 200 1d; # Tradeoff between having the newest info while minimizing requests to Imgur
	proxy_cache_lock on;

	# Rimgo already includes Cache-Control headers
}
# Matches *.rss
location ~ \.rss$ {
	# All locations options
	include conf.d/staging/sites/rimgo/all-locations.conf;

	# Make https into http for darknet sites since Rimgo doesn't respect the scheme
	sub_filter "https://$host" "$scheme://$host";
	# This happens many times
	sub_filter_once off;
	# We're filtering rss
	sub_filter_types application/rss+xml;

	# Try to minimize requests to these pages
	proxy_cache_valid 200 1d; # Tradeoff between having the newest info while minimizing requests to Imgur
	proxy_cache_lock on;

	# Make sure the proper links are cached for each host
	proxy_cache_key "$host $request_uri";
}

# Resources
# This is regex so that the regex for images below it doesn't override it
# Everything in /static/ has no version control by default
# We'll use dynamic etags to fix that
# Has etags and are internal
location ~ \/static\/ {
	# All locations options
	include conf.d/staging/sites/rimgo/all-locations.conf;

	# Dynamic etags
	# https://github.com/dvershinin/ngx_dynamic_etag
	dynamic_etag on;
	dynamic_etag_types *;
	dynamic_etag_strength weak;

	# These will always need to be used by multiple people and are essential to the site
	proxy_cache_min_uses 1;

	# Caching options
	include conf.d/staging/cache-options/static-with-etag-or-last-modified.conf;
}
# Matches *.webp, *.jpg, *. jpeg, *.png, *.gif, and *.mp4
# All of these should never change and are external
location ~ \.(?:webp|jpe?g|png|gif|mp4)$ {
	# All locations options
	include conf.d/staging/sites/rimgo/all-locations.conf;

	# Try to minimize requests to these resources
	proxy_cache_valid 200 206 1y; # Never refresh, these won't change
	proxy_cache_lock on;

	# Caching options
	include conf.d/staging/cache-options/images.conf;
}
