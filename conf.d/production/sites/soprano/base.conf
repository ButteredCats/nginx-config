# Error pages
include conf.d/production/error-pages/error-pages.conf;

# Special files
include conf.d/production/special-files.conf;

# Common headers
include conf.d/production/headers/common-headers.conf;

# Set of directives that tell the browser what can be loaded from where
# Possible options can be found here https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy
# Browsers will show things that were blocked and what directive blocked them in the console
# base-uri, frame-ancestors, and form-action don't fall back to default-src
more_set_headers -t 'text/html' "Content-Security-Policy: default-src 'none'; style-src 'self'; img-src 'self'; base-uri 'none'; frame-ancestors 'none'; form-action 'self'";

# Relaxed for gifs and webps so they can embed on other pages for use with replacer plugins or somewhere like Discord
more_set_headers -t 'image/gif image/webp' 'Cross-Origin-Resource-Policy: cross-origin'; 

# Site specific proxy cache options
# https://nginx.org/en/docs/http/ngx_http_proxy_module.html
proxy_cache_min_uses 3;
proxy_cache_key "$request_uri";

# Pages
location = / {
	# All locations options
	include conf.d/production/sites/soprano/all-locations.conf;

	# Have clients cache the page forever
	more_set_headers -s '200' 'Cache-Control: max-age=31536000';

	# Make https into http for darknet sites since Soprano doesn't respect the scheme
	sub_filter "https://$host" "$scheme://$host";

	# Make sure proper link shows on each host
	proxy_cache_key "$host $request_uri";
}
location / {
	# All locations options
	include conf.d/production/sites/soprano/all-locations.conf;

	# Try to minimize requests to these pages
	proxy_cache_valid 200 1y; # Never refresh, these won't change
	proxy_cache_lock on;

	# Have clients cache the page forever
	more_set_headers -s '200' 'Cache-Control: max-age=31536000';
}
location /search {
	# All locations options
	include conf.d/production/sites/soprano/all-locations.conf;

	# Try to minimize requests to these pages
	proxy_cache_valid 200 1d; # Tradeoff between having the newest info while minimizing requests to Tenor
	proxy_cache_valid 301 1y; # These redirects will never change
	proxy_cache_lock on;

	# Have clients cache the page for 1 day
	more_set_headers -s '200' 'Cache-Control: max-age=86400';

	# Have clients cache the redirect to the page forever
	more_set_headers -s '301' 'Cache-Control: max-age=31536000';
}

# Resources
# Has no version control by default
# We'll use dynamic etags to fix that
# Has etags and is internal
location ~ \/(?:style\.css|favicon\.png)$ {
	# All locations options
	include conf.d/production/sites/soprano/all-locations.conf;

	# Dynamic etags
	# https://github.com/dvershinin/ngx_dynamic_etag
	dynamic_etag on;
	dynamic_etag_types *;
	dynamic_etag_strength weak;

	# These will always need to be used by multiple people and are essential to the site
	proxy_cache_min_uses 1;

	# Caching options
	include conf.d/production/cache-options/static-with-etag-or-last-modified.conf;
}
# /proxy includes all images proxied from Tenor
# These will never change and are external
location /proxy {
	# All locations options
	include conf.d/production/sites/soprano/all-locations.conf;

	# Try to minimize requests to these resources
	proxy_cache_valid 200 206 1y; # Never refresh, these won't change
	proxy_cache_lock on;

	# Caching options
	include conf.d/production/cache-options/images.conf;
}
