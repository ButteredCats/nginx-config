# Error pages
include conf.d/production/error-pages/error-pages.conf;

# Special files
include conf.d/production/special-files.conf;

# Common headers
include conf.d/production/headers/common-headers.conf;

# Set of directives that tell the browser what can be loaded from where
# Possible options can be found here https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy
# Browsers will show things that were blocked and what directive blocked them in the console
# base-uri, frame-ancestors, and form-action don't fall back to default-src
more_set_headers -t 'text/html' "Content-Security-Policy: default-src 'none'; style-src 'self' 'unsafe-inline'; img-src 'self'; base-uri 'none'; frame-ancestors 'none'; form-action 'none'";

# Remove cache control headers so we can override those
proxy_hide_header cache-control;

# Site specific proxy cache options
# https://nginx.org/en/docs/http/ngx_http_proxy_module.html
proxy_cache_valid 200 206 7d;
proxy_cache_valid any 1d;
proxy_cache_min_uses 3;
proxy_cache_key "$request_uri";

# Pages
location = / {
	# All locations options
	include conf.d/production/sites/nerdsfornerds/all-locations.conf;

	# Have clients cache the page for 1 week
	more_set_headers "Cache-Control: max-age=604800";

	# Make https into http for darknet sites
	# NerdsforNerds obeys the host header in the example, but doesn't obey the scheme so we manually swap it
	sub_filter "https://$host" "$scheme://$host";

	# Make sure proper link shows on each host
	proxy_cache_key "$host $request_uri";
}
location / {
	# All locations options
	include conf.d/production/sites/nerdsfornerds/all-locations.conf;

	# Have clients cache the page for 1 week
	more_set_headers "Cache-Control: max-age=604800";
}

# Resources
location = /style.css {
	# Location options
	include conf.d/production/sites/nerdsfornerds/resources/static.conf;
}
# Resources
location = /favicon.png {
	# Location options
	include conf.d/production/sites/nerdsfornerds/resources/static-use-old.conf;
}
# /proxy just includes all images proxied from geeksforgeeks
location /proxy {
	# Location options
	include conf.d/production/sites/nerdsfornerds/resources/images.conf;
}
